# ===============================
# UNIVERSAL ZSH CONFIG (MAC + LINUX)
# ===============================

# PATH default (Linux)
export PATH="$HOME/bin:$HOME/.local/bin:$PATH"

# Add Homebrew to PATH if on macOS
if [[ "$OSTYPE" == "darwin"* ]]; then
  # Check for Apple Silicon Mac
  if [[ -d "/opt/homebrew/bin" ]]; then
    export PATH="/opt/homebrew/bin:$PATH"
  # Check for Intel Mac
  elif [[ -d "/usr/local/bin" ]]; then
    export PATH="/usr/local/bin:$PATH"
  fi
fi

# Detect OS (mac / linux)
case "$OSTYPE" in
  darwin*) export OS="mac";;
  linux*)  export OS="linux";;
esac

### -------------------------------
### ZINIT (Fast plugin manager)
### -------------------------------
if [[ ! -f ~/.zinit/bin/zinit.zsh ]]; then
  mkdir -p ~/.zinit
  git clone https://github.com/zdharma-continuum/zinit.git ~/.zinit/bin
fi

source ~/.zinit/bin/zinit.zsh

### -------------------------------
### PLUGINS (fast load)
### -------------------------------
zinit light zsh-users/zsh-autosuggestions
zinit light zsh-users/zsh-completions

# Syntax highlighting MUST be last
SYNTAX_PLUGIN="zsh-users/zsh-syntax-highlighting"

### -------------------------------
### ZOXIDE (smart cd)
### -------------------------------
eval "$(zoxide init zsh)"

### -------------------------------
### FZF (universal configs)
### -------------------------------
export FZF_DEFAULT_COMMAND='fd --type f'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_ALT_C_COMMAND='fd --type d'

### -------------------------------
### ALIASES
### -------------------------------
alias ls='lsd'
alias cat='bat'
alias g='git'
alias lg='lazygit'
alias c='clear'
alias reload='source ~/.zshrc'

### -------------------------------
### QUALITY OF LIFE
### -------------------------------
setopt autocd
setopt interactive_comments
setopt correct

### -------------------------------
### LOAD SYNTAX HIGHLIGHTING LAST
### -------------------------------
zinit light $SYNTAX_PLUGIN

### -------------------------------
### NVM (Node Version Manager)
### -------------------------------
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

### -------------------------------
### PROJECT STARTER FUNCTIONS
### -------------------------------
# Generic function to start a project with backend and frontend
# Helper function to open Cursor with directories
_open-cursor() {
  local dirs=("$@")
  
  if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS: Try cursor command first (most reliable)
    if command -v cursor &> /dev/null; then
      for dir in "${dirs[@]}"; do
        if [[ -n "$dir" && -d "$dir" ]]; then
          # Use cursor command - each call opens a new window
          echo "  ğŸ“‚ Opening: $dir"
          cursor "$dir" > /dev/null 2>&1 &
        else
          echo "  âš ï¸  Directory not found: $dir"
        fi
      done
      # Small delay after all opens to ensure separate windows
      sleep 0.3
      return 0
    fi
    
    # Fallback: Use open -n -a Cursor
    if [ -d "/Applications/Cursor.app" ]; then
      for dir in "${dirs[@]}"; do
        if [[ -n "$dir" && -d "$dir" ]]; then
          echo "  ğŸ“‚ Opening: $dir"
          # Use -n flag to open in a new window
          open -n -a Cursor "$dir" 2>/dev/null
        else
          echo "  âš ï¸  Directory not found: $dir"
        fi
      done
      sleep 0.3
      return 0
    fi
  else
    # Linux: Try cursor command
    if command -v cursor &> /dev/null; then
      for dir in "${dirs[@]}"; do
        if [[ -n "$dir" && -d "$dir" ]]; then
          echo "  ğŸ“‚ Opening: $dir"
          cursor "$dir" > /dev/null 2>&1 &
        else
          echo "  âš ï¸  Directory not found: $dir"
        fi
      done
      sleep 0.3
      return 0
    fi
    
    # Fallback: Try Linux paths
    if [ -f "/usr/share/cursor/bin/cursor" ]; then
      for dir in "${dirs[@]}"; do
        if [[ -n "$dir" && -d "$dir" ]]; then
          echo "  ğŸ“‚ Opening: $dir"
          /usr/share/cursor/bin/cursor "$dir" > /dev/null 2>&1 &
        else
          echo "  âš ï¸  Directory not found: $dir"
        fi
      done
      sleep 0.3
      return 0
    fi
  fi
  
  return 1
}

# Helper function to find directory using zoxide
_find-dir() {
  local pattern=$1
  local dir=$(zoxide query "$pattern" 2>/dev/null)
  
  if [[ -n "$dir" && -d "$dir" ]]; then
    echo "$dir"
    return 0
  fi
  
  return 1
}

# Helper function to check if Docker is running
_check-docker() {
  if docker ps &> /dev/null 2>&1; then
    return 0  # Docker is running
  fi
  
  # Try to start Docker on Linux (systemd)
  if [[ "$OSTYPE" == "linux"* ]]; then
    if command -v systemctl &> /dev/null; then
      echo "ğŸ³ Docker is not running. Attempting to start Docker service..."
      if sudo systemctl start docker 2>/dev/null; then
        sleep 2
        if docker ps &> /dev/null 2>&1; then
          echo "âœ“ Docker is now running"
          return 0
        fi
      fi
    fi
  fi
  
  echo "âŒ Docker is not running. Please start Docker manually:"
  if [[ "$OSTYPE" == "linux"* ]]; then
    echo "   sudo systemctl start docker"
  else
    echo "   Start Docker Desktop from Applications"
  fi
  return 1
}

# Helper function to check if backend is already running
_is-backend-running() {
  # First check if Docker is running
  if ! _check-docker; then
    return 1  # Docker not running, so backend can't be running
  fi
  
  # Check if postgres container is running
  if docker ps --format '{{.Names}}' 2>/dev/null | grep -q "postgres"; then
    # Check if there's a node/yarn process running
    if pgrep -f "yarn start:dev" > /dev/null 2>&1 || \
       pgrep -f "node.*roll-backend" > /dev/null 2>&1; then
      return 0  # Backend is running
    fi
  fi
  
  return 1  # Backend is not running
}

_start-project() {
  local project_name=$1
  local backend_dir=""
  local frontend_dir=""
  local backend_running=false
  
  # Find backend directory using zoxide
  backend_dir=$(_find-dir "roll-backend")
  if [[ -z "$backend_dir" ]]; then
    echo "âŒ Backend not found. Try: z roll-backend"
    return 1
  fi
  
  # Map project names to zoxide patterns
  case $project_name in
    academy)
      frontend_dir=$(_find-dir "academy-web")
      ;;
    community)
      frontend_dir=$(_find-dir "community-web")
      ;;
    comp)
      frontend_dir=$(_find-dir "comp-web")
      ;;
    events)
      frontend_dir=$(_find-dir "events-web")
      ;;
    *)
      echo "âŒ Unknown project: $project_name"
      echo "   Available: academy, community, comp, events"
      return 1
      ;;
  esac
  
  # Verify frontend directory exists
  if [[ -z "$frontend_dir" ]]; then
    echo "âŒ Frontend not found. Try: z ${project_name}-web"
    return 1
  fi
  
  # Check Docker before proceeding (needed to check if backend is running)
  if ! _check-docker; then
    echo ""
    echo "ğŸ’¡ Tip: Start Docker and try again."
    return 1
  fi
  
  # Check if backend is already running
  if _is-backend-running; then
    backend_running=true
    echo "âœ“ Backend is already running, opening frontend only..."
  fi
  
  # Open projects in Cursor
  echo "ğŸ“ Opening projects in Cursor..."
  if _open-cursor "$backend_dir" "$frontend_dir"; then
    echo "âœ“ Projects opened in Cursor"
  else
    echo "âš ï¸  Cursor not found. Please install Cursor or open manually."
  fi
  
  # Detect terminal and OS
  if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS: Try iTerm2 first, fallback to Terminal.app
    if [[ -d "/Applications/iTerm.app" ]]; then
      if [[ "$backend_running" == true ]]; then
        echo "ğŸš€ Starting $project_name frontend with iTerm2..."
      else
        echo "ğŸš€ Starting $project_name with iTerm2..."
      fi
      
      # Tab 1: Backend (only if not running)
      if [[ "$backend_running" == false ]]; then
        osascript <<EOF 2>/dev/null
tell application "iTerm"
  activate
  tell current window
    create tab with default profile
    tell current session of current tab
      write text "z roll-backend && docker compose up -d postgres && yarn start:dev"
      set name to "backend"
    end tell
  end tell
end tell
EOF
        sleep 0.5
      fi
      
      # Tab 2: Frontend
      osascript <<EOF 2>/dev/null
tell application "iTerm"
  tell current window
    create tab with default profile
    tell current session of current tab
      write text "z ${project_name}-web && yarn dev"
      set name to "$project_name-frontend"
    end tell
  end tell
end tell
EOF
      
      if [[ "$backend_running" == true ]]; then
        echo "âœ“ Frontend started in iTerm2"
      else
        echo "âœ“ Backend and Frontend started in iTerm2 tabs"
      fi
    else
      # Fallback to Terminal.app
      if [[ "$backend_running" == true ]]; then
        echo "ğŸš€ Starting $project_name frontend with Terminal.app..."
      else
        echo "ğŸš€ Starting $project_name with Terminal.app..."
      fi
      
      if [[ "$backend_running" == false ]]; then
        osascript <<EOF 2>/dev/null
tell application "Terminal"
  activate
  do script "z roll-backend && docker compose up -d postgres && yarn start:dev"
end tell
EOF
        sleep 0.5
      fi
      
      osascript <<EOF 2>/dev/null
tell application "Terminal"
  activate
  tell application "System Events" to keystroke "t" using {command down}
  delay 0.5
  do script "z ${project_name}-web && yarn dev" in front window
end tell
EOF
      
      if [[ "$backend_running" == true ]]; then
        echo "âœ“ Frontend started in Terminal.app"
      else
        echo "âœ“ Backend and Frontend started in Terminal.app tabs"
      fi
    fi
  else
    # Linux: Use gnome-terminal or similar
    if command -v gnome-terminal &> /dev/null; then
      if [[ "$backend_running" == true ]]; then
        echo "ğŸš€ Starting $project_name frontend with gnome-terminal..."
        gnome-terminal --tab --title="$project_name-frontend" -- zsh -c "z ${project_name}-web && yarn dev; exec zsh"
        echo "âœ“ Frontend started in gnome-terminal"
      else
        echo "ğŸš€ Starting $project_name with gnome-terminal..."
        gnome-terminal --tab --title="backend" -- zsh -c "z roll-backend && if ! docker ps &>/dev/null; then echo 'ğŸ³ Starting Docker...' && sudo systemctl start docker 2>/dev/null && sleep 2; fi && docker compose up -d postgres && yarn start:dev; exec zsh" \
          --tab --title="$project_name-frontend" -- zsh -c "z ${project_name}-web && yarn dev; exec zsh"
        echo "âœ“ Backend and Frontend started in gnome-terminal tabs"
      fi
    elif command -v xterm &> /dev/null; then
      if [[ "$backend_running" == true ]]; then
        echo "ğŸš€ Starting $project_name frontend with xterm..."
        xterm -T "$project_name-frontend" -e zsh -c "z ${project_name}-web && yarn dev; exec zsh" &
        echo "âœ“ Frontend started in xterm"
      else
        echo "ğŸš€ Starting $project_name with xterm..."
        xterm -T "backend" -e zsh -c "z roll-backend && if ! docker ps &>/dev/null; then echo 'ğŸ³ Starting Docker...' && sudo systemctl start docker 2>/dev/null && sleep 2; fi && docker compose up -d postgres && yarn start:dev; exec zsh" &
        xterm -T "$project_name-frontend" -e zsh -c "z ${project_name}-web && yarn dev; exec zsh" &
        echo "âœ“ Backend and Frontend started in separate xterm windows"
      fi
    else
      echo "âŒ No terminal application found. Please install gnome-terminal"
      return 1
    fi
  fi
}

# Project-specific functions
xacademy() { _start-project "academy" }
xcommunity() { _start-project "community" }
xcomp() { _start-project "comp" }
xevents() { _start-project "events" }

### -------------------------------
### STARSHIP (prompt)
### -------------------------------
eval "$(starship init zsh)"
